image: ruby:2.4.2
stages:
    - build
    - test
    - review
    - stage
    - production

variables:
    DATABASE_URL: 'mongodb://mongo/user_posts'
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

before_script:
    - cd reddit
    - bundle install

build_job:
    image: docker:19.03.1
    stage: build
    before_script:
      - cd reddit
      - docker --version
      
    script:
      - echo 'Building'
      - echo $CI_PROJECT_DIR
      - echo $CI_COMMIT_SHORT_SHA 
      - cd $CI_PROJECT_DIR/docker-monolith
      - docker build -t $LOGIN_DH/reddit:$CI_COMMIT_SHORT_SHA .
      - docker login -u $LOGIN_DH -p $PASSWORD_DH
      - docker push $LOGIN_DH/reddit:$CI_COMMIT_SHORT_SHA

test_unit_job:
    stage: test
    services:
        - mongo:latest
    script:
        - ruby simpletest.rb

test_integration_job:
    stage: test
    script:
        - echo 'Testing 2'

branch review:
    stage: review
    script: echo "Deploy to $CI_ENVIRONMENT_SLUG"
    environment:
        name: branch/$CI_COMMIT_REF_NAME
        url: http://$CI_ENVIRONMENT_SLUG.example.com
    only:
        - branches
    except:
        - master

staging:
    stage: stage
    when: manual
    script:
        - echo 'Deploy'
    only:
        - /^\d+\.\d+\.\d+/
    environment:
        name: stage
        url: https://beta.example.com

production:
    stage: production
    when: manual
    only:
        - /^\d+\.\d+\.\d+/
    script:
        - echo 'Deploy'
    environment:
        name: production
        url: https://example.com
